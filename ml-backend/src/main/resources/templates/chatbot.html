<div th:fragment="chatbotFragment">
    <!-- Chatbot FAB -->
    <div class="chatbot-fab" onclick="toggleChat()">
        <svg viewBox="0 0 24 24">
            <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/>
        </svg>
    </div>

    <!-- Chat Window -->
    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <h4>ì²­ì•½Fit AI ìƒë‹´ì‚¬</h4>
            <button onclick="toggleChat()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">Ã—</button>
        </div>
        <div class="chat-body">
            <div style="background: #f1f3f4; padding: 1rem; border-radius: 12px; margin-bottom: 1rem;">
                ì•ˆë…•í•˜ì„¸ìš”! ì²­ì•½ê³¼ ëŒ€ì¶œì— ëŒ€í•´ ê¶ê¸ˆí•˜ì‹  ì ì´ ìˆìœ¼ì‹ ê°€ìš”? ë¬´ì—‡ì´ë“  ë¬¼ì–´ë³´ì„¸ìš”! ğŸ˜Š
            </div>
        </div>
        <div class="notice-select-container" style="padding: 0.5rem; border-top: 1px solid #e0e0e0;">
            <select id="noticeSelect" class="form-select" style="width: 100%; padding: 0.5rem; border: 1px solid #e0e0e0; border-radius: 4px;">
                <option value="">ê³µê³ ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
            </select>
        </div>
        <div class="chat-input-container">
            <input type="text" class="chat-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...">
            <button class="chat-send">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                </svg>
            </button>
        </div>
    </div>
</div>

<script th:fragment="chatbotScript">
    let isLoggedIn = false;

    // Check login status and fetch notices
    function checkLoginStatus() {
        fetch('/chatbot/check-auth')
            .then(response => response.json())
            .then(data => {
                isLoggedIn = data.authenticated;
                if (isLoggedIn) {
                    fetchNotices();
                }
            })
            .catch(error => console.error('Error checking auth status:', error));
    }

    // Fetch notices
    function fetchNotices() {
        fetch('/chatbot/notices')
            .then(response => response.json())
            .then(notices => {
                const noticeSelect = document.getElementById('noticeSelect');
                noticeSelect.innerHTML = '<option value="">ê³µê³ ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                notices.forEach(notice => {
                    const option = document.createElement('option');
                    option.value = notice.noticeNumber;
                    option.textContent = notice.noticeTitle;
                    noticeSelect.appendChild(option);
                });
            })
            .catch(error => console.error('Error fetching notices:', error));
    }

    // Toggle chat window
    function toggleChat() {
        const chatWindow = document.getElementById('chatWindow');
        chatWindow.classList.toggle('active');
        if (chatWindow.classList.contains('active')) {
            checkLoginStatus();
        }
    }

    // Chat functionality
    document.querySelector('.chat-send').addEventListener('click', sendMessage);
    document.querySelector('.chat-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    function sendMessage() {
        const input = document.querySelector('.chat-input');
        const chatBody = document.querySelector('.chat-body');
        const noticeSelect = document.getElementById('noticeSelect');

        if (input.value.trim()) {
            // Add user message
            const userMessage = document.createElement('div');
            userMessage.style.cssText = 'background: #e3f2fd; padding: 1rem; border-radius: 12px; margin-bottom: 1rem; text-align: right;';
            userMessage.textContent = input.value;
            chatBody.appendChild(userMessage);

            // Send message to API
            fetch('/chatbot/api', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    message: input.value,
                    noticeNumber: noticeSelect.value || ""
                })
            })
            .then(response => response.json())
            .then(data => {
                const aiMessage = document.createElement('div');
                aiMessage.style.cssText = 'background: #f1f3f4; padding: 1rem; border-radius: 12px; margin-bottom: 1rem;';
                aiMessage.textContent = data.reply;
                chatBody.appendChild(aiMessage);
                chatBody.scrollTop = chatBody.scrollHeight;
            })
            .catch(error => {
                console.error('Error:', error);
                const errorMessage = document.createElement('div');
                errorMessage.style.cssText = 'background: #ffebee; padding: 1rem; border-radius: 12px; margin-bottom: 1rem;';
                errorMessage.textContent = 'ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                chatBody.appendChild(errorMessage);
                chatBody.scrollTop = chatBody.scrollHeight;
            });

            input.value = '';
            chatBody.scrollTop = chatBody.scrollHeight;
        }
    }

    // Notice select click handler
    document.getElementById('noticeSelect').addEventListener('click', function(e) {
        if (!isLoggedIn) {
            e.preventDefault();
            const chatBody = document.querySelector('.chat-body');
            const errorMessage = document.createElement('div');
            errorMessage.style.cssText = 'background: #ffebee; padding: 1rem; border-radius: 12px; margin-bottom: 1rem;';
            errorMessage.textContent = 'ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.';
            chatBody.appendChild(errorMessage);
            chatBody.scrollTop = chatBody.scrollHeight;
        }
    });
</script>
