<html layout:decorate="~{layout}">
<th:block layout:fragment="head">
    <title>ê³µê³  ëª©ë¡ - ì²­ì•½í•</title>
</th:block>
<div layout:fragment="content" class="container my-5">
    <!-- Recommendations Section -->
    <div class="page-section" id="recommendations">
        <!-- Summary Box -->
        <div class="summary-box">
            <h3 class="summary-title">
                ğŸ¯ ë‚´ ì •ë³´ ìš”ì•½ & ì¶”ì²œ ê·¼ê±°
            </h3>
            <div class="summary-grid">
                <div class="summary-item">
                    <h4>ğŸ¯ ë‚´ ì •ë³´ ìš”ì•½</h4>
                    <p>29ì„¸ / ë¬´ì£¼íƒ / ìˆ˜ë„ê¶Œ ê±°ì£¼</p>
                    <small>ìì‚° 3.2ì–µì›</small>
                </div>
                <div class="summary-item">
                    <h4>ğŸ§  ì¶”ì²œ ê¸°ì¤€</h4>
                    <p>ì´ 23ê±´ ì¶”ì²œ</p>
                    <small>ìì‚° + ë‚˜ì´ + ê±°ì£¼ì§€ + ë¬´ì£¼íƒ ì—¬ë¶€ ê¸°ì¤€</small>
                </div>
                <div class="summary-item">
                    <h4>ğŸ† ê°€ì‚°ì  ì •ë³´</h4>
                    <p>ì˜ˆìƒ ê°€ì : 34ì </p>
                    <small>ë¬´ì£¼íƒ ê¸°ê°„, ë¶€ì–‘ê°€ì¡± ë“± ë°˜ì˜</small>
                </div>
                <div class="summary-item">
                    <h4>ğŸ” í˜„ì¬ í•„í„°</h4>
                    <p>ì„œìš¸ / 60ã¡ ì´ìƒ</p>
                    <small>ì…ì£¼ 2028ë…„ ì´ì „</small>
                </div>
            </div>
            <div class="summary-actions">
                <button onclick="resetFilters()">ğŸ“Œ í•„í„° ì´ˆê¸°í™”</button>
                <button onclick="openFilterSettings()">âš™ï¸ í•„í„° ì¬ì„¤ì •</button>
                <button onclick="updateMyInfo()">ğŸ“ ë‚´ ì •ë³´ ìˆ˜ì •</button>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-section" id="filterSection">
            <h3 class="filter-title">
                ğŸ” ìƒì„¸ í•„í„°
            </h3>
            <div class="filter-grid">
                <div class="filter-group">
                    <label for="region">ì§€ì—­</label>
                    <select id="region">
                        <option value="">ì „ì²´</option>
                        <option value="seoul" selected>ì„œìš¸</option>
                        <option value="gyeonggi">ê²½ê¸°</option>
                        <option value="incheon">ì¸ì²œ</option>
                        <option value="busan">ë¶€ì‚°</option>
                        <option value="daegu">ëŒ€êµ¬</option>
                        <option value="other">ê¸°íƒ€</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="district">êµ¬/ì‹œ</label>
                    <select id="district">
                        <option value="">ì „ì²´</option>
                        <option value="gangnam">ê°•ë‚¨êµ¬</option>
                        <option value="songpa">ì†¡íŒŒêµ¬</option>
                        <option value="seocho">ì„œì´ˆêµ¬</option>
                        <option value="mapo">ë§ˆí¬êµ¬</option>
                        <option value="other">ê¸°íƒ€</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="area">ì „ìš©ë©´ì </label>
                    <select id="area">
                        <option value="">ì „ì²´</option>
                        <option value="under60">60ã¡ ë¯¸ë§Œ</option>
                        <option value="60to84" selected>60~84ã¡</option>
                        <option value="85to100">85~100ã¡</option>
                        <option value="over100">100ã¡ ì´ˆê³¼</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="price">ë¶„ì–‘ê°€</label>
                    <select id="price">
                        <option value="">ì „ì²´</option>
                        <option value="under5">5ì–µì› ë¯¸ë§Œ</option>
                        <option value="5to7">5~7ì–µì›</option>
                        <option value="7to10">7~10ì–µì›</option>
                        <option value="over10">10ì–µì› ì´ˆê³¼</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="moveInDate">ì…ì£¼ì˜ˆì •</label>
                    <select id="moveInDate">
                        <option value="">ì „ì²´</option>
                        <option value="2027" selected>2027ë…„</option>
                        <option value="2028">2028ë…„</option>
                        <option value="2029">2029ë…„</option>
                        <option value="after2030">2030ë…„ ì´í›„</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label for="applicationType">ì²­ì•½ìœ í˜•</label>
                    <select id="applicationType">
                        <option value="">ì „ì²´</option>
                        <option value="firstTime">ìƒì• ìµœì´ˆ</option>
                        <option value="newlywed">ì‹ í˜¼ë¶€ë¶€</option>
                        <option value="general">ì¼ë°˜ê³µê¸‰</option>
                        <option value="special">íŠ¹ë³„ê³µê¸‰</option>
                    </select>
                </div>
            </div>
            <div class="filter-actions">
                <button class="btn btn-secondary" onclick="resetFilters()">ì´ˆê¸°í™”</button>
                <button class="btn btn-primary" onclick="applyFilters()">í•„í„° ì ìš©</button>
            </div>
        </div>

        <div class="recommendations">
            <h2 class="section-title">ë§ì¶¤ ì²­ì•½ ê³µê³ </h2>
            <div class="tab-container">
                <button class="tab active" onclick="switchTab(this, 'new')">ì „ì²´ ê³µê³ </button>
                <button class="tab" onclick="switchTab(this, 'recommended')">ë§ì¶¤ ê³µê³ </button>
                <button class="tab" onclick="switchTab(this, 'ongoing')">ì§„í–‰ì¤‘ ê³µê³ </button>
            </div>

            <div class="map-container">
                <div class="map-sidebar">
                    <div th:each="notice : ${paging.content}" class="property-list-item" th:onclick="'selectProperty(' + ${notice.id} + ', this)'">
                        <div class="property-header" style="display: flex; justify-content: space-between; align-items: flex-start; gap: 8px;">
                            <div class="property-title" style="flex: 1; min-width: 0; word-break: break-all;" th:text="${notice.noticeTitle}">ê³µê³  ì œëª©</div>
                            <span class="card-badge hot" style="flex-shrink: 0; min-width: 60px; text-align: center;" th:if="${notice.noticeStatus == T(com.mysite.applyhome.notice.NoticeStatus).ì ‘ìˆ˜ì¤‘}">ì ‘ìˆ˜ì¤‘</span>
                            <span class="card-badge over" style="flex-shrink: 0; min-width: 60px; text-align: center;" th:if="${notice.noticeStatus == T(com.mysite.applyhome.notice.NoticeStatus).ì ‘ìˆ˜ë§ˆê°}">ì ‘ìˆ˜ë§ˆê°</span>
                            <span class="card-badge" style="flex-shrink: 0; min-width: 60px; text-align: center;" th:if="${notice.noticeStatus == T(com.mysite.applyhome.notice.NoticeStatus).ê²°ê³¼ë°œí‘œ}">ê²°ê³¼ë°œí‘œ</span>
                        </div>
                        <div class="property-details">
                            <span th:text="${notice.location}">ì§€ì—­</span>
                            <span th:text="${#temporals.format(notice.applicationEndDate, 'yyyy.MM.dd') + ' ë§ˆê°'}">ì²­ì•½ë§ˆê°ì¼</span>
                        </div>
                    </div>
                </div>

                <div class="map-view" id="mapView">
                    <div id="map"></div>
                    <!-- Map markers -->
                    <div th:each="notice : ${paging.content}" 
                         class="map-marker" 
                         th:style="'top: ' + ${notice.id * 10 + 40} + '%; left: ' + ${notice.id * 5 + 40} + '%;'"
                         th:onclick="'selectProperty(' + ${notice.id} + ')'">
                        <span th:text="${notice.id}">1</span>
                    </div>

                    <!-- Property detail panel -->
                    <div class="property-detail-panel" id="propertyDetail">
                        <h3 id="detailTitle"></h3>
                        <div class="property-details" style="flex-direction: column; gap: 1rem; margin-top: 1rem;">
                            <div class="loan-info-row">
                                <span class="loan-label">ê³µê³ ë²ˆí˜¸</span>
                                <span class="loan-value" id="detailNoticeNumber"></span>
                            </div>
                            <div class="loan-info-row">
                                <span class="loan-label">ì§€ì—­</span>
                                <span class="loan-value" id="detailLocation"></span>
                            </div>
                            <div class="loan-info-row">
                                <span class="loan-label">ì²­ì•½ë§ˆê°ì¼</span>
                                <span class="loan-value" id="detailEndDate"></span>
                            </div>
                            <div class="loan-info-row">
                                <span class="loan-label">ìƒíƒœ</span>
                                <span class="loan-value" id="detailStatus"></span>
                            </div>
                        </div>
                        <button class="btn btn-primary" style="width: 100%; margin-top: 1.5rem;">ìƒì„¸ì •ë³´ ë³´ê¸°</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="script">
    <!-- Bootstrap JS -->
<!--    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>-->
    <!-- Kakao Map API -->
    <script type="text/javascript" th:src="@{|//dapi.kakao.com/v2/maps/sdk.js?appkey=${kakaoApiKey}&libraries=services|}"></script>
    
    <!-- ì§€ë„ ê´€ë ¨ JavaScript -->
    <script th:inline="javascript">
        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸ì„ ìœ„í•œ ë³€ìˆ˜
        var isLoggedIn = /*[[${#authentication.principal != 'anonymousUser'}]]*/ false;

        // ì§€ë„ ì´ˆê¸°í™”
        var container = document.getElementById('mapView');
        var options = {
            center: new kakao.maps.LatLng(37.5551, 126.9707),
            level: 10
        };

        var map = new kakao.maps.Map(container, options);
        var geocoder = new kakao.maps.services.Geocoder();
        var markers = [];

        // ê³µê³  ë°ì´í„°ë¥¼ JavaScript ë³€ìˆ˜ë¡œ ê°€ì ¸ì˜¤ê¸°
        var notices = /*[[${paging.content}]]*/ [];

        // ê° ê³µê³ ì˜ ìœ„ì¹˜ë¥¼ ì§€ë„ì— í‘œì‹œ
        function displayNotices(notices) {
            // ê¸°ì¡´ ë§ˆì»¤ ì œê±°
            markers.forEach(marker => marker.setMap(null));
            markers = [];

            notices.forEach(function(notice) {
                if (notice.location) {
                    console.log(notice.location);
                    geocoder.addressSearch(notice.location, function(result, status) {
                        console.log(status);
                        if (status === kakao.maps.services.Status.OK) {
                            var coords = new kakao.maps.LatLng(result[0].y, result[0].x);
                            
                            // ë§ˆì»¤ ìƒì„±
                            var marker = new kakao.maps.Marker({
                                map: map,
                                position: coords
                            });

                            // ì¸í¬ìœˆë„ìš° ìƒì„±
                            var infowindow = new kakao.maps.InfoWindow({
                                content: '<div style="padding:5px;font-size:12px;">' + notice.noticeTitle + '</div>'
                            });

                            // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
                            kakao.maps.event.addListener(marker, 'click', function() {
                                infowindow.open(map, marker);
                            });

                            markers.push(marker);
                        }
                    });
                }
            });
        }

        // ì´ˆê¸° ê³µê³  í‘œì‹œ
        displayNotices(notices);

        // Tab switching
        function switchTab(element, tabName) {
            // Remove active class from all tabs
            const tabs = element.parentElement.querySelectorAll('.tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Add active class to clicked tab
            element.classList.add('active');

            if (tabName === 'recommended') {
                if (!isLoggedIn) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.');
                    // ì´ì „ íƒ­ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                    const previousTab = document.querySelector('.tab.active');
                    if (previousTab) {
                        previousTab.classList.remove('active');
                    }
                    document.querySelector('.tab[onclick*="new"]').classList.add('active');
                    return;
                }
                
                // ì¶”ì²œ ê³µê³  ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                fetch('/notice/api/custom?page=0')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // ê³µê³  ëª©ë¡ ì—…ë°ì´íŠ¸
                        const noticeList = document.querySelector('.map-sidebar');
                        noticeList.innerHTML = '';
                        
                        data.content.forEach(notice => {
                            const noticeElement = createNoticeElement(notice);
                            noticeList.appendChild(noticeElement);
                        });
                        
                        // ì§€ë„ ë§ˆì»¤ ì—…ë°ì´íŠ¸
                        displayNotices(data.content);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert(error.message || 'ì¶”ì²œ ê³µê³ ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        // ì—ëŸ¬ ë°œìƒ ì‹œ ì „ì²´ ê³µê³  íƒ­ìœ¼ë¡œ ëŒì•„ê°€ê¸°
                        const previousTab = document.querySelector('.tab.active');
                        if (previousTab) {
                            previousTab.classList.remove('active');
                        }
                        document.querySelector('.tab[onclick*="new"]').classList.add('active');
                    });
            } else if (tabName === 'ongoing') {
                // ì§„í–‰ì¤‘ì¸ ê³µê³ ë§Œ í•„í„°ë§
                const ongoingNotices = notices.filter(notice => notice.noticeStatus === 'ì ‘ìˆ˜ì¤‘');
                
                // ê³µê³  ëª©ë¡ ì—…ë°ì´íŠ¸
                const noticeList = document.querySelector('.map-sidebar');
                noticeList.innerHTML = '';
                
                ongoingNotices.forEach(notice => {
                    const noticeElement = createNoticeElement(notice);
                    noticeList.appendChild(noticeElement);
                });
                
                // ì§€ë„ ë§ˆì»¤ ì—…ë°ì´íŠ¸
                displayNotices(ongoingNotices);
            } else if (tabName === 'new') {
                // ëª¨ë“  ê³µê³  í‘œì‹œ
                const noticeList = document.querySelector('.map-sidebar');
                noticeList.innerHTML = '';
                
                notices.forEach(notice => {
                    const noticeElement = createNoticeElement(notice);
                    noticeList.appendChild(noticeElement);
                });
                
                // ì§€ë„ ë§ˆì»¤ ì—…ë°ì´íŠ¸
                displayNotices(notices);
            }
        }

        // ê³µê³  ìš”ì†Œ ìƒì„± í•¨ìˆ˜
        function createNoticeElement(notice) {
            const div = document.createElement('div');
            div.className = 'property-list-item';
            div.onclick = () => selectProperty(notice.id, div);
            
            div.innerHTML = `
                <div class="property-header" style="display: flex; justify-content: space-between; align-items: flex-start; gap: 8px;">
                    <div class="property-title" style="flex: 1; min-width: 0; word-break: break-all;">${notice.noticeTitle}</div>
                    <span class="card-badge ${notice.noticeStatus === 'ì ‘ìˆ˜ì¤‘' ? 'hot' : notice.noticeStatus === 'ì ‘ìˆ˜ë§ˆê°' ? 'over' : ''}">${notice.noticeStatus}</span>
                </div>
                <div class="property-details">
                    <span>${notice.location}</span>
                    <span>${new Date(notice.applicationEndDate).toLocaleDateString()} ë§ˆê°</span>
                </div>
            `;
            
            return div;
        }

        // Property selection
        function selectProperty(id, element) {
            // Remove active class from all items
            document.querySelectorAll('.property-list-item').forEach(item => {
                item.classList.remove('active');
            });

            // Add active class to clicked item
            if (element) {
                element.classList.add('active');
            } else {
                // If called from map marker, find the corresponding list item
                document.querySelectorAll('.property-list-item')[id - 1].classList.add('active');
            }

            // Show property detail
            const detailPanel = document.getElementById('propertyDetail');
            detailPanel.classList.add('active');

            // Get notice data from the clicked element
            const noticeElement = element || document.querySelector(`.property-list-item:nth-child(${id})`);
            const title = noticeElement.querySelector('.property-title').textContent;
            const location = noticeElement.querySelector('.property-details span:first-child').textContent;
            const endDate = noticeElement.querySelector('.property-details span:last-child').textContent;
            const status = noticeElement.querySelector('.card-badge')?.textContent || 'ì ‘ìˆ˜ì¤‘';

            // Update detail panel
            document.getElementById('detailTitle').textContent = title;
            document.getElementById('detailLocation').textContent = location;
            document.getElementById('detailEndDate').textContent = endDate;
            document.getElementById('detailStatus').textContent = status;
        }
    </script>
</th:block>
</html> 